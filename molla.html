<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Massa–Molla con smorzamento</title>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.2/lib/p5.min.js"></script>
  <style>
    :root{
      --bg:#f7f7f7; --card:#fff; --text:#222; --muted:#666;
      --accent:#0072B2; --ctl:#eaeaea; --ctl-border:#d0d0d0;
      --ok:#3BAFDA; --warn:#F4B400; --good:#2ecc71;
    }
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    .wrap{max-width:1100px;margin:24px auto;padding:16px;background:var(--card);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.08);}
    h1{margin:0 0 6px;font-size:22px;color:var(--accent)}
    .sub{color:var(--muted);margin-bottom:16px}
    #canvas-holder{width:100%;border:1px solid #eee;border-radius:12px;overflow:hidden}
    .controls{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;margin-top:14px;align-items:center}
    .group{background:var(--ctl);border:1px solid var(--ctl-border);border-radius:10px;padding:10px}
    .span-12{grid-column:span 12}.span-6{grid-column:span 6}.span-4{grid-column:span 4}.span-3{grid-column:span 3}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type="range"]{width:100%;accent-color:var(--accent)}
    .btn{appearance:none;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;background:#ccc;transition:transform .05s ease,box-shadow .2s ease;font-weight:600;box-shadow:0 2px 0 rgba(0,0,0,.15)}
    .btn:active{transform:translateY(1px);box-shadow:0 1px 0 rgba(0,0,0,.2)}
    .btn.accent{background:var(--accent);color:#fff}
    .btn.blue{background:var(--ok);color:#083042}
    .btn.yellow{background:var(--warn);color:#5c4300}
    .chip{background:#fff;border:1px solid var(--ctl-border);border-radius:999px;padding:6px 10px;font-weight:600}
    .bar{height:10px;background:#eee;border-radius:6px;overflow:hidden}
    .bar > div{height:100%;background:var(--good)}
    .hint{font-size:12px;color:var(--muted)}
    @media (max-width:820px){.controls{grid-template-columns:repeat(6,1fr)}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Massa–Molla con smorzamento</h1>
    <div class="sub">Sinistra: molla e massa. • Destra: \(x(t)\) con finestra scorrevole. • In basso: controlli e energie.</div>
    <div id="canvas-holder"></div>

    <div class="controls">
      <div class="group span-12">
        <div class="row">
          <button id="btn-play" class="btn">Blocca</button>
          <button id="btn-reset" class="btn">Reset</button>
          <button id="btn-nudge" class="btn accent">Impulso (+A)</button>
          <span class="hint">Usa “Impulso” per impostare uno spostamento iniziale (v=0).</span>
        </div>
      </div>

      <div class="group span-6">
        <h3>Molla k (N/m)</h3>
        <div class="row" style="width:100%">
          <input id="slider-k" type="range" min="10" max="100" step="10" value="40" />
          <span class="chip">k = <span id="label-k">40</span></span>
        </div>
      </div>

      <div class="group span-6">
        <h3>Massa m (kg)</h3>
        <div class="row" style="width:100%">
          <input id="slider-m" type="range" min="0.5" max="5" step="0.5" value="1.0" />
          <span class="chip">m = <span id="label-m">1.0</span></span>
        </div>
      </div>

      <div class="group span-4">
        <h3>Smorzamento c (kg/s)</h3>
        <div class="row">
          <button id="btn-c" class="btn blue">c = 0.20</button>
          <span class="hint">Cicla tra 0, 0.2, 0.5, 1.0</span>
        </div>
      </div>

      <div class="group span-4">
        <h3>Ampiezza discreta A (m)</h3>
        <div class="row">
          <button id="btn-A" class="btn yellow">A = 0.40</button>
          <span class="hint">Cicla: 0.2 – 1.0</span>
        </div>
      </div>

      <div class="group span-4">
        <h3>Energia istantanea</h3>
        <div class="row" style="width:100%">
          <div style="flex:1">
            <div class="hint">Cinetica \(E_k\)</div>
            <div class="bar"><div id="ek-bar" style="width:0%"></div></div>
          </div>
          <div style="flex:1">
            <div class="hint">Elastica \(E_p\)</div>
            <div class="bar"><div id="ep-bar" style="width:0%"></div></div>
          </div>
        </div>
        <div class="row">
          <span class="chip">\(E_k\) = <span id="ek-val">0.00</span> J</span>
          <span class="chip">\(E_p\) = <span id="ep-val">0.00</span> J</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------------- Parametri discreti / stato ----------------
    const holder = document.getElementById('canvas-holder');
    let W=1000,H=460; let leftPad=20,topPad=20,rightPad=20,bottomPad=20;
    let left={x:0,y:0,w:0,h:0}, right={x:0,y:0,w:0,h:0};

    // Controlli
    const kSlider = document.getElementById('slider-k');
    const mSlider = document.getElementById('slider-m');
    const kLabel = document.getElementById('label-k');
    const mLabel = document.getElementById('label-m');
    const btnPlay = document.getElementById('btn-play');
    const btnReset = document.getElementById('btn-reset');
    const btnNudge = document.getElementById('btn-nudge');
    const btnC = document.getElementById('btn-c');
    const btnA = document.getElementById('btn-A');

    const ekBar = document.getElementById('ek-bar');
    const epBar = document.getElementById('ep-bar');
    const ekVal = document.getElementById('ek-val');
    const epVal = document.getElementById('ep-val');

    // Valori discreti
    const cOptions = [0.0, 0.2, 0.5, 1.0]; let cIdx = 1;
    const AOptions = [0.2, 0.4, 0.6, 0.8, 1.0]; let AIdx = 1;

    // Stato fisico (SI semplificati)
    let k = +kSlider.value;     // N/m
    let m = +mSlider.value;     // kg
    let c = cOptions[cIdx];     // kg/s
    let x = 0.4;                // m
    let v = 0.0;                // m/s
    let paused = false;

    // Tempo / grafico
    let t=0, last=null;
    const windowSec = 10, lead = 1.0;
    const trail = [];

    // ---------------- Layout p5 ----------------
    const sketch = (p)=>{
      p.setup = ()=>{
        const cnv = p.createCanvas(W,H); cnv.parent(holder);
        p.textFont('system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif');
        layout();
        p.frameRate(60);
      };
      p.windowResized = ()=>{
        const r = holder.getBoundingClientRect();
        W = Math.max(720, Math.min(1100, Math.floor(r.width)));
        H = Math.floor(W*0.46);
        p.resizeCanvas(W,H); layout();
      };

      p.draw = ()=>{
        p.background(255);

        const now = p.millis()/1000;
        if(last===null) last=now;
        let dt = now-last; last=now; dt = Math.min(dt, 0.05);

        if(!paused){
          // Modello: m x'' + c x' + k x = 0  →  a = -(c/m) v - (k/m) x
          const a = -(c/m)*v - (k/m)*x;
          // Integrazione stabile: Euler-Cromer
          v += a*dt;
          x += v*dt;
          t += dt;
        }

        // Salva punto per grafico
        trail.push({t,y:x});
        const tStart = Math.max(0, t-(windowSec));
        while(trail.length && trail[0].t < tStart-2) trail.shift();

        // Disegni
        drawLeft(p);
        drawRight(p);

        // Energie
        const Ek = 0.5*m*v*v;
        const Ep = 0.5*k*x*x;
        ekVal.textContent = Ek.toFixed(2);
        epVal.textContent = Ep.toFixed(2);
        const scale = 1.0 + 0.5*k/100; // scala fittizia per barre
        ekBar.style.width = Math.min(100, 100*Ek/scale)+'%';
        epBar.style.width = Math.min(100, 100*Ep/scale)+'%';
      };
    };
    new p5(sketch);

    function layout(){
      const pad=20, mid=20;
      const usableW = W-leftPad-rightPad;
      const pw = Math.floor((usableW-mid)/2);
      const ph = H-topPad-bottomPad;
      left = {x:leftPad, y:topPad, w:pw, h:ph};
      right = {x:leftPad+pw+mid, y:topPad, w:pw, h:ph};
    }

    // ---------------- Disegni ----------------
    function axes(p, x,y,w,h){
      p.push(); p.stroke(0); p.strokeWeight(1);
      // orizzontale centro
      p.line(x, y+h/2, x+w, y+h/2);
      // verticale centro
      p.line(x+w/2, y, x+w/2, y+h);
      p.pop();
    }

    function drawLeft(p){
      const x0 = left.x, y0 = left.y, w = left.w, h = left.h;
      axes(p, x0,y0,w,h);

      // Scala spaziale: A=1 m occupa ~40% larghezza
      const pxPerMeter = w*0.4;
      const anchorX = x0 + w*0.1;
      const railY = y0 + h*0.6;

      // Molla disegnata a zig-zag
      const X = anchorX + x*pxPerMeter; // posizione del blocco in px
      const springLen = Math.max(40, X - anchorX - 30);
      p.push();
      p.stroke(160); p.strokeWeight(2); p.noFill();
      const coils = 10;
      p.beginShape();
      p.vertex(anchorX, railY);
      for(let i=1;i<=coils;i++){
        const xx = anchorX + (springLen*i)/coils;
        const yy = railY + (i%2===0 ? -20 : 20);
        p.vertex(xx, yy);
      }
      p.vertex(anchorX + springLen, railY);
      p.endShape();
      p.pop();

      // Blocco massa
      p.push();
      p.fill(240); p.stroke(60); p.strokeWeight(2);
      const boxW=60, boxH=40;
      p.rect(X, railY-boxH/2, boxW, boxH, 6);
      p.pop();

      // Indicazioni numeriche
      p.push();
      p.fill(0); p.noStroke();
      p.textSize(13);
      p.text(`x = ${x.toFixed(2)} m`, X+boxW+8, railY-6);
      p.text(`v = ${v.toFixed(2)} m/s`, X+boxW+8, railY+12);
      p.pop();
    }

    function drawRight(p){
      const x0 = right.x, y0 = right.y, w = right.w, h = right.h;
      axes(p, x0,y0,w,h);

      // Griglia orizzontale
      p.push(); p.stroke(235); p.strokeWeight(1);
      for(let i=-2;i<=2;i++){
        const yy = p.map(i,-2,2, y0+h, y0);
        p.line(x0, yy, x0+w, yy);
      }
      p.pop();

      const tEnd = t + 1.0; // margine "lead"
      const tStart = Math.max(0, tEnd - windowSec);

      // Curva x(t)
      p.push(); p.noFill(); p.stroke(0,114,178); p.strokeWeight(2);
      p.beginShape();
      for(const pt of trail){
        if(pt.t < tStart-1 || pt.t > tEnd+1) continue;
        const xx = mapLinear(pt.t, tStart, tEnd, x0, x0+w);
        const yy = mapLinear(pt.y, -1.5, 1.5, y0+h, y0); // scala y
        p.vertex(xx, yy);
      }
      p.endShape();
      p.pop();

      // Pallino corrente
      const yNow = x;
      const xDot = mapLinear(t, tStart, tEnd, x0, x0+w);
      const yDot = mapLinear(yNow, -1.5, 1.5, y0+h, y0);
      p.push(); p.fill(220,50,47); p.noStroke(); p.circle(xDot, yDot, 12); p.pop();
    }

    function mapLinear(val, a,b, c,d){ return c + (val-a)*(d-c)/(b-a); }

    // ---------------- Interazione ----------------
    kSlider.addEventListener('input', ()=>{
      k = +kSlider.value; kLabel.textContent = k;
      softRefresh();
    });
    mSlider.addEventListener('input', ()=>{
      m = +mSlider.value; mLabel.textContent = (+m).toFixed(1);
      softRefresh();
    });

    btnPlay.addEventListener('click', ()=>{
      paused = !paused;
      btnPlay.textContent = paused ? 'Riprendi' : 'Blocca';
      softRefresh(0);
    });

    btnReset.addEventListener('click', ()=>{
      t=0; x = AOptions[AIdx]; v=0; trail.length=0;
      softRefresh(0);
    });

    btnNudge.addEventListener('click', ()=>{
      // Imposta spostamento iniziale (come dare x0 = +A, v=0)
      x = AOptions[AIdx]; v = 0;
      softRefresh();
    });

    btnC.addEventListener('click', ()=>{
      cIdx = (cIdx + 1) % cOptions.length;
      c = cOptions[cIdx];
      btnC.textContent = `c = ${c.toFixed(2)}`;
      softRefresh();
    });

    btnA.addEventListener('click', ()=>{
      AIdx = (AIdx + 1) % AOptions.length;
      btnA.textContent = `A = ${AOptions[AIdx].toFixed(2)}`;
    });

    function softRefresh(pauseMs=120){
      const was = paused; paused = true;
      // Aggiorna trail con lo stato attuale per evitare “salti”
      const Ek = 0.5*m*v*v, Ep = 0.5*k*x*x;
      ekVal.textContent = Ek.toFixed(2);
      epVal.textContent = Ep.toFixed(2);
      setTimeout(()=>{ paused = was; }, pauseMs);
    }

    // Primo layout
    window.dispatchEvent(new Event('resize'));
  </script>
</body>
</html>
